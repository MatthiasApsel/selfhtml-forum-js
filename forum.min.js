/*
JavaScript für die benutzerspezifische Ansicht des SELFHTML-Forums (http://forum.de.selfhtml.org/)
Author: Mathias Schäfer (molily)
Lizenz: MIT License
*/
if(!Object.forEach){Object.forEach=function(a,b){for(var c in a){if(a.hasOwnProperty(c)){b.call(a,c,a[c])}}}}if(!Array.prototype.forEach){Array.prototype.forEach=function(c){if(typeof c!="function"){throw new TypeError()}var a=this.length;for(var b=0;b<a;b++){c.call(this,this[b],b)}}}if(!Array.prototype.filter){Array.prototype.filter=function(b){var a=this.length;if(typeof b!="function"){throw new TypeError()}var e=new Array();var d=arguments[1];for(var c=0;c<a;c++){if(c in this){var f=this[c];if(b.call(d,f,c,this)){e.push(f)}}}return e}}String.prototype.escapeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")};if(!Element.prototype.contains){Element.prototype.contains=function(a){return(this.compareDocumentPosition(a)&16)==16}}Element.prototype.getElementByXPath=function(a){return document.evaluate(a,this,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null).singleNodeValue};Element.prototype.getElementsByXPath=function(a){return document.evaluate(a,this,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null)};XPathResult.prototype.forEach=function(d){var c,a=0,b=this.resultType==XPathResult.ORDERED_NODE_ITERATOR_TYPE?"iterateNext":"snapshotItem";while(c=this[b](a++)){d(c)}};XPathResult.prototype.toArray=function(){var a=[],d,b=0,c=this.resultType==XPathResult.ORDERED_NODE_ITERATOR_TYPE?"iterateNext":"snapshotItem";while(d=this[c](b++)){a.push(d)}return a};(function(){var d={};var e=Element.prototype;e.toggleClass=function b(g){if(this.hasClass(g)){this.removeClass(g)}else{this.addClass(g)}};e.addClass=function f(g){if(!this.hasClass(g)){this.className+=(this.className?" ":"")+g}};e.removeClass=function a(g){this.className=this.className.replace(new RegExp("(^|\\s)"+g+"(\\s|$)"),"$2")};e.hasClass=function c(g){return(" "+this.className+" ").indexOf(" "+g+" ")>-1};delete e})();var SELFHTML={};SELFHTML.Forum={};SELFHTML.Forum.getThreadStart=function SELFHTML_Forum_getThreadStart(a){return a.getElementByXPath("ancestor::li[contains(@class, 'thread-start')]")};SELFHTML.Forum.Debug={};SELFHTML.Forum.Debug=function(g,c,f){c=c||document.documentElement;f=f||500;console.log("benchmarking",g,"at",c);var j=new Date().getTime();try{for(var d=0;d<f;d++){var a=document.evaluate(g,c,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null)}}catch(h){console.debug(h);return}var b=new Date().getTime();console.log(g,"found",a.snapshotLength,"nodes in ",(b-j),"ms");return a};Function.prototype.benchmark=function(d){console.log("benchmarking a function");d=d||1000;var e=new Date().getTime();for(var c=0;c<d;c++){var a=this()}var b=new Date().getTime();console.log(d,"iterations took",(b-e),"ms");return a};SELFHTML.Forum.Modules={};SELFHTML.Forum.Modules.queue=[];SELFHTML.Forum.Modules.add=function(a,b){SELFHTML.Forum.Modules.queue.push({documentType:a,module:b})};SELFHTML.Forum.Modules.init=function(){SELFHTML.Forum.Modules.queue.forEach(function a(b){if(document.body.id=="selfforum-"+b.documentType||b.documentType=="all"){b.module.init()}})};document.addEventListener("DOMContentLoaded",SELFHTML.Forum.Modules.init,false);SELFHTML.Forum.init=function(){SELFHTML.Forum.ready=true};SELFHTML.Forum.Modules.add("all",SELFHTML.Forum);SELFHTML.Forum.Hauptseite={};SELFHTML.Forum.Hauptseite.init=function(){SELFHTML.Forum.threadList=document.getElementById("root")};SELFHTML.Forum.Modules.add("hauptseite",SELFHTML.Forum.Hauptseite);SELFHTML.Forum.ThreadListCache={};SELFHTML.Forum.ThreadListCache.init=function(){var o=SELFHTML.Forum,p=(o.postingsByAuthor={}),k=(o.threadStartsByAuthor={}),g=(o.ownPostings=[]),e=(o.postingsByCategory={}),m=o.threadList.getElementsByClassName?o.threadList.getElementsByClassName("author"):o.threadList.getElementsByXPath("descendant::span[@class = 'author']").toArray();for(var j=0,b=m.length;j<b;j++){var h=m[j],l=h.firstChild.nodeValue,a=h.parentNode,n=a.parentNode,d=n.id,c=n.parentNode.parentNode,f;if(n.hasClass("own-posting")){g.push(n);if(!o.ownName){o.ownName=l}}(p[l]||(p[l]=[])).push(n);if(c.hasClass("thread-start")){(k[l]||(k[l]=[])).push(c)}f=a.firstChild.firstChild.childNodes[1].nodeValue;(e[f]||(e[f]=[])).push(n)}};SELFHTML.Forum.Modules.add("hauptseite",SELFHTML.Forum.ThreadListCache);SELFHTML.Forum.ContextMenu={};SELFHTML.Forum.ContextMenu.init=function(){var a=SELFHTML.Forum,b=a.ContextMenu;b.target=document.getElementById("contextMenuTitle");a.threadList.addEventListener("click",b.toggle,false);a.threadList.addEventListener("mouseover",b.threadListMouseOver,true)};SELFHTML.Forum.Modules.add("hauptseite",SELFHTML.Forum.ContextMenu);SELFHTML.Forum.ContextMenu.toggle=function(k){var p=SELFHTML.Forum,b=p.Config,m=p.ContextMenu,c=p.Filter,g=p.Statistics,l=k.target,q=l.hasClass("author"),i=l.hasClass("category"),a=l.hasClass("cathigh"),j=i||a;if(!(q||j)){m.hide();return}var o={};if(q){var n=l.firstChild.nodeValue,f=l.hasClass("own-posting"),h=l.hasClass("whitelist");o["Filtere nach Autor"]=function(){c.filterByAuthor(n)};if(h){o["Autor von der Whitelist löschen"]=function(){b.removeFromWhiteList(n)}}else{if(!f){o["Autor zur Whitelist hinzufügen"]=function(){b.addToWhiteList(n)}}}if(!f){o["Autor zur Blacklist hinzufügen"]=function(){b.addToBlackList(n)}}o["Zeige Autoren-Statistik"]=function(){g.show("author")}}else{if(j){var d=l.childNodes[1].nodeValue;o["Filtere nach Themenbereich"]=function(){c.filterByCategory(d)};if(i){o["Themenbereich hervorheben"]=function(){b.addToHighlightCategories(d)}}else{o["Themenbereich nicht mehr hervorheben"]=function(){b.removeFromHighlightCategories(d)}}o["Zeige Themenbereich-Statistik"]=function(){g.show("category")}}}o["Menü ausblenden"]=function(){m.hide()};m.show(l,o)};SELFHTML.Forum.ContextMenu.show=function(e,a){var d=SELFHTML.Forum,f=d.ContextMenu;if(f.target){f.target.removeAttribute("id")}e.id="contextMenuTitle";var c=new d.Layer({id:"contextMenu",tagName:"ul"}),b=c.element;while(b.firstChild){b.removeChild(b.firstChild)}Object.forEach(a,function(k,i){var j=function(l){l.preventDefault();i.call(this,l)};var g=document.createElement("li");b.appendChild(g);var h=document.createElement("a");g.appendChild(h);h.href="javascript:void(0)";h.addEventListener("click",j,false);h.appendChild(document.createTextNode(k))});b.style.top=(e.offsetTop+e.offsetHeight)+"px";b.style.left=e.offsetLeft+"px";c.show();f.target=e};SELFHTML.Forum.ContextMenu.hide=function(){var a=SELFHTML.Forum,b=a.ContextMenu;if(b.target){b.target.removeAttribute("id")}new a.Layer({id:"contextMenu"}).hide()};SELFHTML.Forum.ContextMenu.threadListMouseOver=function(c){var a=SELFHTML.Forum,b=c.target;if(!b.hasClass("javascript-button")&&(b.hasClass("author")||b.hasClass("category")||b.hasClass("cathigh"))){b.addClass("javascript-button")}};SELFHTML.Forum.Layer=function(a){if(!a||!a.id){throw new TypeError}var c=arguments.callee.layers||(arguments.callee.layers={});if(c[a.id]){return c[a.id]}if(!a.tagName){return}if(!a.parent){a.parent=document.body}var b=document.createElement(a.tagName);b.id=a.id;if(a.className){b.className=a.className}a.parent.appendChild(b);this.element=b;c[a.id]=this};SELFHTML.Forum.Layer.prototype={show:function f_Layer_prototype_show(){if(this.element){this.element.style.display="block"}return this},hide:function f_Layer_prototype_hide(){if(this.element){this.element.style.display="none"}return this},html:function f_Layer_prototype_html(a){if(this.element){this.element.innerHTML=a}return this}};SELFHTML.Forum.Info={};SELFHTML.Forum.Info.show=function(a){new SELFHTML.Forum.Layer({id:"scriptInfo",tagName:"div",parent:document.getElementById("kopf-haupt")}).html(a).show()};SELFHTML.Forum.Info.hide=function(a){new SELFHTML.Forum.Layer({id:"scriptInfo"}).hide()};SELFHTML.Forum.Filter={};SELFHTML.Forum.Filter.init=function(){var a=SELFHTML.Forum.Filter;a.active=false;a.highlightedPostings=[];a.filteredThreads=[];a.initCategoryFilter()};SELFHTML.Forum.Modules.add("hauptseite",SELFHTML.Forum.Filter);SELFHTML.Forum.Filter.initCategoryFilter=function(){var c=SELFHTML.Forum,a=c.Filter,b=document.getElementById("themenfilter").getElementsByTagName("form")[0];b.addEventListener("submit",function(h){h.preventDefault();var d=this.elements.lf,f=d.options[d.selectedIndex],g=f.text;if(f.value){a.filterByCategory(g)}else{a.remove()}},false)};SELFHTML.Forum.Filter.filterByAuthor=function(a){var d=SELFHTML.Forum,b=d.Filter;b.remove();d.ContextMenu.hide();var c=d.postingsByAuthor[a];if(c){c.forEach(function e(f){f.addClass("highlighted");b.highlightedPostings.push(f);var g=d.getThreadStart(f);g.addClass("contains-filter-postings");b.filteredThreads.push(g)})}d.threadList.addClass("filter");d.Info.show("Gefiltert nach Autor "+a+" &ndash; <a href='javascript:SELFHTML.Forum.Filter.remove()'>Filter entfernen</a>");b.active=true};SELFHTML.Forum.Filter.filterByCategory=function(e){var d=SELFHTML.Forum,b=d.Filter;b.remove();d.ContextMenu.hide();var c=d.postingsByCategory[e];if(c){c.forEach(function a(f){var g=d.getThreadStart(f);g.addClass("contains-filter-postings");b.filteredThreads.push(g)})}d.threadList.addClass("filter");d.Info.show("Gefiltert nach Themenbereich "+e+" &ndash; <a href='javascript:SELFHTML.Forum.Filter.remove()'>Filter entfernen</a>");b.active=true};SELFHTML.Forum.Filter.remove=function(){var c=SELFHTML.Forum,b=c.Filter;if(!b.active){return}c.Info.hide();var d,a;while(d=b.filteredThreads.shift()){d.removeClass("contains-filter-postings")}while(a=b.highlightedPostings.shift()){a.removeClass("highlighted")}c.threadList.removeClass("filter");b.active=false};SELFHTML.Forum.FollowupNotice={};SELFHTML.Forum.FollowupNotice.init=function(){var j=SELFHTML.Forum,a=j.threadList.getElementsByXPath("descendant::li[contains(@class, 'own-posting')]/child::ul/child::li[not(contains(@class, 'visited'))]").toArray();var i="kopf-menue",g=document.getElementById(i);if(!g){return}var b=new Date().getTime(),h=[];a.forEach(function d(m){var k,l,o,n;k={};k.element=m;l=m.getElementByXPath("(child::span | child::span/child::span)[contains(@class, 'posting')]");o=l.getElementByXPath("child::span[contains(@class, 'subject')]/child::a");if(window.getComputedStyle(o,null).outlineStyle=="solid"){console.log("Link hat keine visited-Klasse, ist aber in der Browser-History als besucht markiert");return}k.title=o.firstChild.nodeValue;k.href=o.href;n=l.getElementByXPath("child::span[contains(@class, 'author')]/text()");k.author=n.nodeValue;h.push(k)});var f=new j.Layer({id:"followup-notice",tagName:"div",parent:g});var e="";if(h.length>0){f.element.className="new-anwers";e+="<h2>Neue Antworten</h2>";e+="<ul>";h.forEach(function c(k){e+="<li><a href='"+k.href+"'>"+k.title.escapeHTML()+"</a>";e+=" von "+k.author.escapeHTML()+"</li>"});e+="</ul>"}else{f.element.className="no-anwers";e+="<h2>Keine neuen Antworten</h2>"}f.html(e)};SELFHTML.Forum.Modules.add("hauptseite",SELFHTML.Forum.FollowupNotice);SELFHTML.Forum.Config={};SELFHTML.Forum.Config.directives={BlackList:{parameter:"blacklist",type:"list"},WhiteList:{parameter:"whitelst",type:"list"},HighlightCategories:{parameter:"highlightcats",type:"list"},SortThreads:{parameter:"sortthreads",type:"single"}};SELFHTML.Forum.Config.init=function(){var a=SELFHTML.Forum,b=a.Config;Object.forEach(b.directives,function(d,c){if(c.type!="list"){return}b["addTo"+d]=function(e){b.setValue(d,e);b.confirmReload()};b["removeFrom"+d]=function(e){b.removeValue(d,e);b.confirmReload()}})};SELFHTML.Forum.Modules.add("hauptseite",SELFHTML.Forum.Config);SELFHTML.Forum.Config.setValue=function(f,c){var b=SELFHTML.Forum,e=b.Config,d=e.directives[f];if(!d){return}var a=userconf_uri+"?a=setvalue&directive="+f+"&"+d.parameter+"="+encodeURIComponent(c)+(d.type=="list"?"&type=stringlist":"")+"&unique="+new Date().getTime();xmlhttp_get_contents(xmlhttp,a,null,null)};SELFHTML.Forum.Config.removeValue=function(f,c){var b=SELFHTML.Forum,e=b.Config,d=e.directives[f];if(!d){return}var a=userconf_uri+"?a=removevalue&directive="+f+"&"+d.parameter+"="+encodeURIComponent(c)+(d.type=="list"?"&type=stringlist":"")+"&unique="+new Date().getTime();xmlhttp_get_contents(xmlhttp,a,null,null)};SELFHTML.Forum.Config.confirmReload=function(){var a="Die Einstellung wurde auf dem Server gespeichert. Soll die Forumshauptseite jetzt neu geladen werden?";if(window.confirm(a)){location.reload()}};SELFHTML.Forum.Statistics={};SELFHTML.Forum.Statistics.init=function(h){if(typeof h!="string"){arguments.callee("author");arguments.callee("category");return}var l=SELFHTML.Forum,a=l.Filter,e=l.Statistics,j=(h=="author")?l.postingsByAuthor:l.postingsByCategory,k,c=[];Object.forEach(j,function d(m,n){c.push({typeName:m,postingNumber:n.length})});c.sort(function b(n,m){return n.postingNumber>m.postingNumber?-1:1});if(h=="author"){l.authorRanking=c}else{l.categoryRanking=c}var f="<p><a href='javascript:void(0)' class='hide'>Ausblenden</a></p>";f+="<table><tbody>";c.forEach(function i(m){f+="<tr><th><a href='javascript:void(0)'>"+m.typeName.escapeHTML()+"</th><td>"+m.postingNumber+"</td></tr>"});f+="</tbody></table>";var g=new l.Layer({id:h+"Statistics",tagName:"div",className:"statistics"});g.html(f);g.element.addEventListener("click",function(o){o.preventDefault();var n=o.target;if(n.nodeName.toLowerCase()!="a"){return}e.hide();if(n.hasClass("hide")){return}var m="filterBy"+(h=="author"?"Author":"Category");a[m](n.textContent)},false)};SELFHTML.Forum.Modules.add("hauptseite",SELFHTML.Forum.Statistics);SELFHTML.Forum.Statistics.show=function(c){var d=SELFHTML.Forum;d.ContextMenu.hide();var b=new d.Layer({id:c+"Statistics"});b.show();var e=window.pageYOffset+10,a=window.innerHeight-10-10-(2*5)-2-16;b.element.style.top=e+"px";b.element.style.maxHeight=a+"px"};SELFHTML.Forum.Statistics.hide=function(){var a=SELFHTML.Forum;new a.Layer({id:"categoryStatistics"}).hide();new a.Layer({id:"authorStatistics"}).hide()};SELFHTML.Forum.Sorting={};SELFHTML.Forum.Sorting.init=function(){var a=document.getElementById("themenfilter");if(!a){return}var b=document.createElement("div");b.id="sortierung";b.innerHTML="<p><strong>Sortierung der Threads:</strong></p><ul><li><label title='Threads nach Eröffnungsposting chronologisch absteigend sortieren (neue Threads oben, alte Threads unten)'><input type='radio' name='sortthreads' value='descending' />&nbsp;Absteigend (Standard)</label></li><li><label title='Threads nach Eröffnungsposting chronologisch absteigend sortieren (alte Threads oben, neue Threads unten)'><input type='radio' name='sortthreads' value='ascending' />&nbsp;Aufsteigend</label></li><li><label title='Threads nach dem jüngsten Posting sortieren (Threads mit neuen Postings oben, nicht mehr aktive unten)'><input type='radio' name='sortthreads' value='newestfirst' />&nbsp;Nach jüngstem Posting</label></li></ul>";b.addEventListener("click",SELFHTML.Forum.Sorting.change,false);a.parentNode.insertBefore(b,a)};SELFHTML.Forum.Modules.add("hauptseite",SELFHTML.Forum.Sorting);SELFHTML.Forum.Sorting.change=function(d){var f=SELFHTML.Forum.Config,c=d.target,a=c.nodeName.toLowerCase(),b;if(a!="input"){return}d.stopPropagation();f.setValue("SortThreads",c.value);f.confirmReload()};